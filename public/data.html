<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donn√©es gel</title>
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-light mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">Gel des Avoirs</a>
      <div>
        <a class="nav-link d-inline text-uppercase me-3" href="app.html">Accueil</a>
        <a class="nav-link d-inline text-uppercase me-3" href="data.html">Gel des avoirs</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Donn√©es des Publications</h1>
      <div>
        <button class="btn btn-primary me-2"
          onclick="exportToPDF(document.getElementById('searchInput').value)">Exporter en PDF</button>
        <button class="btn btn-info" onclick="checkForUpdates()">üîÑ V√©rifier les mises √† jour</button>
      </div>
    </div>
    <p id="publicationDate" class="text-muted mb-4">√âtabli sur la base de donn√©es du gel des avoirs en date du {}</p>
    <p id="updateStatus" class="mb-2"></p>
    <div id="loadingUpdate" class="mt-2" style="display:none;">
      <p>Mise √† jour des donn√©es en cours... <span class="spinner-border spinner-border-sm" role="status"
          aria-hidden="true"></span></p>
    </div>

    <input type="text" id="searchInput" class="form-control mb-4" onkeyup="searchTable()"
      placeholder="üîç Rechercher par nom ou pr√©nom..." />

    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="dataTable">
        <thead class="table-light">
          <tr>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>Nature</th>
            <th>Date de Naissance</th>
            <th>Motifs</th>
            <th>Fondement Juridique</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
        <tfoot id="noResults">
          <tr style="display:none;">
            <td colspan="6" class="text-center">Pas de donn√©es correspondant √† votre recherche.</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script>
    //const API_BASE_URL = 'http://192.168.1.94:3000';
    //const API_BASE_URL = "http://localhost:3000";
    const API_BASE_URL = 'http://192.168.101.54:3000';

    async function getLatestDatabaseDate() {
      try {
        const response = await fetch(`${API_BASE_URL}/dernier-gel`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const date = await response.json();
        return date;
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration de la date de la base de donn√©es:', error);
        return null;
      }
    }

    async function getLatestApiDate() {
      try {
        const response = await fetch(`${API_BASE_URL}/dernier-gel`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration de la date de l\'API:', error);
        return null;
      }
    }

    async function fetchAndStoreJson() {
      document.getElementById('loadingUpdate').style.display = 'block';
      document.getElementById('updateStatus').textContent = '';
      try {
        const response = await fetch(`${API_BASE_URL}/dernier-fichier-json`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        console.log('Mise √† jour des donn√©es r√©ussie:', result);
        document.getElementById('updateStatus').innerHTML = '<span class="text-success">Base de donn√©es mise √† jour avec succ√®s. La page va se recharger.</span>';
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration et de l\'enregistrement du JSON:', error);
        document.getElementById('updateStatus').innerHTML = '<span class="text-danger">Erreur lors de la mise √† jour des donn√©es. Veuillez r√©essayer plus tard.</span>';
        document.getElementById('loadingUpdate').style.display = 'none';
      }
    }

    async function checkForUpdates() {
      document.getElementById('updateStatus').textContent = 'V√©rification des mises √† jour...';
      const dbDate = await getLatestDatabaseDate();
      const apiDate = await getLatestApiDate();

      if (dbDate && apiDate) {
        if (dbDate < apiDate) {
          document.getElementById('updateStatus').innerHTML = '<span class="text-warning">Une mise √† jour est disponible. Mise √† jour en cours...</span>';
          await fetchAndStoreJson();
        } else if (dbDate > apiDate) {
          document.getElementById('updateStatus').innerHTML = '<span class="text-info">Votre base de donn√©es est plus r√©cente que les donn√©es de l\'API.</span>';
        } else {
          document.getElementById('updateStatus').innerHTML = '<span class="text-success">Votre base de donn√©es est √† jour.</span>';
        }
      } else {
        document.getElementById('updateStatus').innerHTML = '<span class="text-danger">Impossible de v√©rifier les mises √† jour. Veuillez r√©essayer.</span>';
      }
    }

    async function fetchData() {
      try {
        const response = await fetch(`${API_BASE_URL}/data`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        populateTable(data);
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des donn√©es:', error);
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="6">Erreur lors du chargement des donn√©es.</td></tr>`;
      }
    }

    async function fetchPublicationDate() {
      try {
        const response = await fetch(`${API_BASE_URL}/dernier-gel`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const publicationDateISO = await response.json();
        const publicationDate = new Date(publicationDateISO);
        const formattedDate = publicationDate.toLocaleDateString('fr-FR');
        document.getElementById('publicationDate').textContent = `√âtabli sur la base de donn√©es du gel des avoirs en date du ${formattedDate}`;
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration de la date de publication:', error);
        document.getElementById('publicationDate').textContent = `Erreur lors du chargement de la date.`;
      }
    }

    function populateTable(data) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';

      data.forEach(person => {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${person.nom || ''}</td>
          <td>${person.prenom || ''}</td>
          <td>${person.nature || ''}</td>
          <td>${person.date_de_naissance || ''}</td>
          <td>${person.motifs || ''}</td>
          <td>${person.fondement_juridique_label || ''}</td>
        `;
      });
      document.getElementById('noResults').rows[0].style.display = 'none';
    }

    function searchTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.trim().toUpperCase();
      const table = document.getElementById("dataTable");
      const rows = table.getElementsByTagName("tr");
      const noResultsRow = document.getElementById("noResults").rows[0];
      let found = false;

      for (let i = 1; i < rows.length; i++) {
        if (i === 0) continue;
        const cells = rows[i].getElementsByTagName("td");
        let match = false;
        if (cells.length > 1) {
          const nomCell = cells[0];
          const prenomCell = cells[1];

          if (
            (nomCell && nomCell.textContent.toUpperCase().includes(filter)) ||
            (prenomCell && prenomCell.textContent.toUpperCase().includes(filter))
          ) {
            match = true;
            found = true;
          }
        }
        rows[i].style.display = match ? "" : "none";
      }

      noResultsRow.style.display = found ? "none" : "";
    }

    fetchData();
    fetchPublicationDate();

    async function exportToPDF(searchTerm) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const table = document.getElementById('dataTable');
      const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
        .filter(row => row.style.display !== 'none');

      const headerRow = table.querySelector('thead tr');
      const headers = Array.from(headerRow.querySelectorAll('th')).map(th => th.textContent);
      const data = [];

      visibleRows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
          rowData.push(cell.textContent);
        });
        data.push(rowData);
      });

      const noResultsRow = document.getElementById("noResults").rows[0];
      const noResultsVisible = noResultsRow.style.display !== 'none';

      const pageWidth = pdf.internal.pageSize.getWidth();
      const mainTitleText = "Interrogation GEL DES AVOIRS";
      const commonFontSize = 10;
      const verticalSpacing = 15;
      const tableTitleColor = [5, 81, 140]; // RGB for #05518C
      const tableHeaderBackgroundColor = [5, 81, 140]; // RGB for #05518C - for header background
      const tableHeaderTextColor = [255, 255, 255]; // RGB for white - for header text
      const tableTitleFontSize = 12;
      const searchTermFontSize = 12; // Font size for "R√©sultats de la recherche" and the term
      const tableTitleMarginTop = 15; // Space above the table title
      const tableTitleText = "R√©sultats de la recherche :";
      const searchTermSpacing = 6; // Space between title and search term
      const searchTermVerticalOffset = 0; // Adjust for vertical alignment
      pdf.setFontSize(14);
      const mainTitleWidth = pdf.getTextWidth(mainTitleText);
      const mainTitleCenterX = (pageWidth - mainTitleWidth) / 2;

      const logoImg = new Image();
      logoImg.onload = async function () {
        const logoWidth = 100;
        const logoHeight = (this.height / this.width) * logoWidth;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const xPosition = (pageWidth - logoWidth) / 2;
        const yPosition = 10;
        let currentY = yPosition + logoHeight + verticalSpacing;

        pdf.addImage(logoImg, 'PNG', xPosition, yPosition, logoWidth, logoHeight);
        pdf.text(mainTitleText, mainTitleCenterX, currentY);
        pdf.setFontSize(commonFontSize);
        currentY += verticalSpacing;

        const publicationDateISO = await getLatestDatabaseDate();
        let formattedDate = '';
        if (publicationDateISO) {
          const publicationDate = new Date(publicationDateISO);
          formattedDate = publicationDate.toLocaleDateString('fr-FR');
        }
        pdf.text(`Base de donn√©es du gel des avoirs en date du ${formattedDate}`, 10, currentY);
        const tableStartY = currentY + verticalSpacing + tableTitleMarginTop;

        pdf.setFontSize(searchTermFontSize); // Set font size for the title
        pdf.setTextColor(...tableTitleColor); // Set the color for the table title
        pdf.text(tableTitleText, 10, tableStartY - 15);
        pdf.setTextColor(0); // Reset text color to black

        if (searchTerm) {
          pdf.setFontSize(searchTermFontSize); // Set font size for the search term
          pdf.text(searchTerm, 10 + pdf.getTextWidth(tableTitleText) + searchTermSpacing, tableStartY - 15 + searchTermVerticalOffset);
          pdf.setFontSize(12); // Reset font size for the table content
        } else {
          pdf.setFontSize(12); // Reset font size for the table content
        }

        const actualTableStartY = tableStartY;

        if (noResultsVisible) {
          const noResultsText = "Aucun registre correspondant √† la recherche.";
          const textWidth = pdf.getTextWidth(noResultsText);
          const centerX = (pageWidth - textWidth) / 2;
          pdf.text(noResultsText, centerX, actualTableStartY);
          pdf.save('interrogation_gel_avoirs.pdf');
        } else {
          if (typeof pdf.autoTable === 'function') {
            pdf.autoTable({
              head: [headers.map(header => ({
                content: header,
                styles: { fillColor: tableHeaderBackgroundColor, textColor: tableHeaderTextColor }
              }))],
              body: data,
              startY: actualTableStartY,
            });
            pdf.save('interrogation_gel_avoirs.pdf');
          } else {
            console.error('jspdf-autotable plugin not loaded!');
            alert('Erreur: Le plugin d\'export PDF n\'est pas charg√©. Veuillez r√©essayer plus tard.');
            let y = actualTableStartY;
            const lineHeight = 7;
            // Basic table header
            pdf.setFillColor(...tableHeaderBackgroundColor);
            pdf.setTextColor(...tableHeaderTextColor);
            let startX = 10;
            headers.forEach(header => {
              pdf.rect(startX, y - lineHeight, 28, lineHeight, 'F'); // Draw filled rectangle for background
              pdf.text(header, startX + 2, y - 2); // Adjust text position
              startX += 30; // Adjust spacing as needed
            });
            pdf.setTextColor(0);
            y += lineHeight + 2; // Add space between header and data
            pdf.setFontSize(10);
            // Basic table data
            data.forEach(row => {
              let x = 10;
              row.forEach(cell => {
                pdf.text(cell, x, y);
                x += 30;
              });
              y += lineHeight;
            });
            pdf.save('interrogation_gel_avoirs_basic_with_logo.pdf');
          }
        }
      };
      logoImg.onerror = async function () {
        console.error('Error loading logo image:', logoImg.src);
        alert('Erreur: Impossible de charger le logo pour le PDF.');
        let currentY = 20;
        const mainTitleY = currentY;
        pdf.text(mainTitleText, mainTitleCenterX, mainTitleY);
        pdf.setFontSize(commonFontSize);
        currentY += verticalSpacing;

        const subtitleY = currentY;
        const publicationDateISO = await getLatestDatabaseDate();
        let formattedDate = '';
        if (publicationDateISO) {
          const publicationDate = new Date(publicationDateISO);
          formattedDate = publicationDate.toLocaleDateString('fr-FR');
        }
        pdf.text(`Base de donn√©es du gel des avoirs en date du ${formattedDate}`, 10, subtitleY);
        const tableStartY = currentY + verticalSpacing + tableTitleMarginTop;

        pdf.setFontSize(searchTermFontSize); // Set font size for the title
        pdf.setTextColor(...tableTitleColor); // Set the color for the table title
        pdf.text(tableTitleText, 10, tableStartY - 15);
        pdf.setTextColor(0); // Reset text color to black

        if (searchTerm) {
          pdf.setFontSize(searchTermFontSize); // Set font size for the search term
          pdf.text(searchTerm, 10 + pdf.getTextWidth(tableTitleText) + searchTermSpacing, tableStartY - 15 + searchTermVerticalOffset);
          pdf.setFontSize(12); // Reset font size for the table content
        } else {
          pdf.setFontSize(12); // Reset font size for the table content
        }

        const actualTableStartY = tableStartY;

        if (noResultsVisible) {
          const noResultsText = "Aucun registre correspondant √† la recherche.";
          const textWidth = pdf.getTextWidth(noResultsText);
          const centerX = (pageWidth - textWidth) / 2;
          pdf.text(noResultsText, centerX, actualTableStartY);
          pdf.save('interrogation_gel_avoirs.pdf');
        } else {
          if (typeof pdf.autoTable === 'function') {
            pdf.autoTable({
              head: [headers.map(header => ({
                content: header,
                styles: { fillColor: tableHeaderBackgroundColor, textColor: tableHeaderTextColor }
              }))],
              body: data,
              startY: actualTableStartY,
            });
            pdf.save('interrogation_gel_avoirs.pdf');
          } else {
            // Basic table header
            pdf.setFillColor(...tableHeaderBackgroundColor);
            pdf.setTextColor(...tableHeaderTextColor);
            let startX = 10;
            headers.forEach(header => {
              pdf.rect(startX, y - lineHeight, 28, lineHeight, 'F'); // Draw filled rectangle for background
              pdf.text(header, startX + 2, y - 2); // Adjust text position
              startX += 30; // Adjust spacing as needed
            });
            pdf.setTextColor(0);
            y += lineHeight + 2; // Add space between header and data
            pdf.setFontSize(10);
            // Basic table data
            data.forEach(row => {
              let x = 10;
              row.forEach(cell => {
                pdf.text(cell, x, y);
                x += 30;
              });
              y += lineHeight;
            });
            pdf.save('interrogation_gel_avoirs_basic.pdf');
          }
        }
      };
      logoImg.src = '/images/banniere.png';
    }

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</body>

</html>